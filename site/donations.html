<div
  class="circus-fundraising-widget"
  data-current="18132.48" 
>
</div>

<style>
  :root {
    --circus-cream:   #f2f0e5;
    --circus-red:     #df4e36;
    --circus-charcoal:#282423;
    --circus-navy:    #4d566e;
    --circus-green:   #67b9b3;
  }

  .circus-fundraising-widget {
    max-width: 420px;
    margin: 1.5rem auto;
    padding: 1.25rem 1.25rem 1.5rem;
    border-radius: 18px;
    background: var(--circus-cream);
    color: var(--circus-charcoal);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    box-shadow: 0 10px 25px rgba(0,0,0,0.12);
  }

  .circus-fundraising-header {
    text-align: center;
    margin-bottom: 0.25rem;
  }

  .circus-fundraising-title {
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    color: var(--circus-charcoal);
  }

  .circus-fundraising-subtitle {
    font-size: 0.85rem;
    margin-top: 0.15rem;
    color: rgba(40,36,35,0.85);
  }

  .circus-donation-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    margin-top: 0.4rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    background: rgba(77,86,110,0.18);
    color: var(--circus-charcoal);
    font-size: 0.8rem;
    font-weight: 500;
  }

  .circus-donation-pill-tag {
    padding: 0.05rem 0.4rem;
    border-radius: 999px;
    background: var(--circus-navy);
    color: var(--circus-cream);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-weight: 700;
    white-space: nowrap;
  }

  .circus-match-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    margin-top: 0.4rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    background: rgba(103,185,179,0.18);
    color: var(--circus-charcoal);
    font-size: 0.8rem;
    font-weight: 500;
  }

  .circus-match-pill-tag {
    padding: 0.05rem 0.4rem;
    border-radius: 999px;
    background: var(--circus-green);
    color: var(--circus-cream);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-weight: 700;
    white-space: nowrap;
  }

  .circus-arc-wrapper {
    position: relative;
    margin: 1.2rem auto 0.75rem;
    max-width: 320px;
  }

  .circus-arc {
    width: 100%;
    display: block;
    overflow: visible; /* allow labels to render outside the viewBox */
  }

  .circus-arc path {
    fill: none;
    stroke-linecap: butt;
  }

  .circus-arc-bg {
    stroke: rgba(40,36,35,0.15);
    stroke-width: 12;
  }

  /* Impact arc: total (donations + match) */
  .circus-arc-impact {
    stroke: var(--circus-green);
    stroke-width: 12;
    stroke-dasharray: 0;
    stroke-dashoffset: 0;
    transition: stroke-dashoffset 0.3s ease-out;
    filter: drop-shadow(0 0 6px rgba(103,185,179,0.75));
  }

  /* Donations arc: overlays the impact arc */
  .circus-arc-donations {
    stroke: var(--circus-navy);
    stroke-width: 12;
    stroke-dasharray: 0;
    stroke-dashoffset: 0;
    transition: stroke-dashoffset 0.3s ease-out;
    filter: drop-shadow(0 0 6px rgba(77,86,110,0.75));
  }

  .circus-arc-markers {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  .circus-arc-marker-dot {
    stroke: var(--circus-cream);
    stroke-width: 2;
  }

  .circus-arc-marker-line {
    stroke: rgba(40,36,35,0.45);
    stroke-width: 1.5;
  }

  .circus-arc-marker-label {
    font-size: 7px;
    fill: rgba(40,36,35,0.9);
  }

  .circus-arc-marker-upcoming .circus-arc-marker-dot {
    fill: rgba(40,36,35,0.25);
  }
  .circus-arc-marker-active .circus-arc-marker-dot {
    fill: var(--circus-green);
  }
  .circus-arc-marker-reached .circus-arc-marker-dot {
    fill: var(--circus-red);
  }

  .circus-arc-marker-reached .circus-arc-marker-line,
  .circus-arc-marker-reached .circus-arc-marker-label {
    stroke: var(--circus-red);
    fill: var(--circus-red);
  }

  .circus-arc-centre {
    position: absolute;
    left: 50%;
    top: 70%;
    transform: translate(-50%, -50%);
    text-align: center;
    pointer-events: none;
  }

  .circus-amount-main {
    font-size: clamp(0.95rem, 2.8vw, 1.35rem);
    font-weight: 800;
    color: var(--circus-charcoal);
  }

  .circus-amount-impact {
    font-size: clamp(0.7rem, 0.6rem + 0.4vw, 1rem);
    margin-top: 0.1rem;
    color: rgba(40,36,35,0.9);
  }

  .circus-amount-impact strong {
    font-weight: 700;
    color: var(--circus-red);
  }

  .circus-amount-goal {
    font-size: 0.8rem;
    color: rgba(40,36,35,0.75);
    margin-top: 0.1rem;
  }

  .circus-milestones {
    margin: 0.75rem 0 0;
    padding: 0.6rem 0 0;
    border-top: 1px solid rgba(40,36,35,0.12);
    list-style: none;
  }

  .circus-milestone {
    display: grid;
    grid-template-columns: auto 1fr auto;
    column-gap: 0.55rem;
    row-gap: 0.05rem;
    align-items: flex-start;
    padding: 0.35rem 0;
  }

  .circus-milestone-dot {
    width: 0.7rem;
    height: 0.7rem;
    border-radius: 999px;
    margin-top: 0.16rem;
  }

  .circus-milestone.reached .circus-milestone-dot {
    background: var(--circus-red);
  }

  .circus-milestone.active .circus-milestone-dot {
    background: var(--circus-green);
  }

  .circus-milestone.upcoming .circus-milestone-dot {
    background: rgba(40,36,35,0.25);
  }

  .circus-milestone-main {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--circus-charcoal);
  }

  .circus-milestone-text {
    grid-column: 2 / span 2;
    font-size: 0.78rem;
    line-height: 1.35;
    color: rgba(40,36,35,0.85);
  }

  .circus-milestone-amount {
    font-size: 0.8rem;
    font-weight: 600;
    color: rgba(40,36,35,0.9);
    white-space: nowrap;
  }

  @media (max-width: 480px) {
    .circus-fundraising-widget {
      padding: 1rem 0.9rem 1.1rem;
      border-radius: 16px;
    }
    .circus-arc-centre {
      top: 55%;
    }
    .circus-fundraising-title {
      font-size: 1rem;
    }
  }
</style>

<script>
(function() {
  const container = document.querySelector('.circus-fundraising-widget');
  if (!container) return;

  // ----- CONFIG -----
  const rawAmount = Number(container.dataset.current || '0'); // actual donations
  const matchCap = 35000;       // first $15k is matched 1:1
  const matchMaxImpact = 70000; // up to $30k total impact from that match band
  const topGoal = 200000;       // highest milestone

  const matchedPortion = Math.min(rawAmount, matchCap);
  const effectiveAmount = rawAmount + matchedPortion; // TOTAL including match

  const milestones = [
    {
      id: 'equipment',
      label: 'Helps us keep and safely store our specialised circus equipment.',
      start: 70000
    },
    {
      id: 'roving',
      label: 'Supports a Term 2 roving programme so Youth Circus students can keep training.',
      start: 80000
    },
    {
      id: 'shared-space',
      label: 'Helps us move into a new, likely shared space and restart a good portion of our classes.',
      start: 100000
    },
    {
      id: 'standalone',
      label: 'Opens up the option to explore a dedicated circus space for future training.',
      start: 150000
    },
    {
      id: 'current-space',
      label: 'Gives us flexibility to explore staying in our current space alongside other venue options.',
      start: 200000
    }
  ];

  function formatNZD(amount) {
    return '$' + Math.round(amount).toLocaleString('en-NZ');
  }

  function milestoneLabelAmount(m) {
    if (m.end && m.end !== m.start) {
      return formatNZD(m.start) + '–' + formatNZD(m.end);
    }
    return formatNZD(m.start);
  }

  function milestoneStatus(effective, m) {
    const start = m.start;
    const end = m.end || m.start;

    if (effective >= end) return 'reached';
    if (effective >= start && effective < end) return 'active';
    return 'upcoming';
  }

  function impactBreakdownText(donated, matched) {
    if (matched <= 0) {
      return `This includes ${formatNZD(donated)} in donations.`;
    }
    return `This includes ${formatNZD(donated)} in donations and ${formatNZD(matched)} in matching.`;
  }

  // ----- BUILD INNER HTML -----
  container.innerHTML = `
    <div class="circus-fundraising-header">
      <div class="circus-fundraising-title">Help secure the future of circus in Wellington</div>
    </div>

    <div class="circus-arc-wrapper">
      <svg class="circus-arc" viewBox="0 0 200 120" aria-hidden="true">
        <!-- semi-circle from left to right along the bottom -->
        <path class="circus-arc-bg" d="M20 100 A80 80 0 0 1 180 100" />
        <path class="circus-arc-impact" d="M20 100 A80 80 0 0 1 180 100" />
        <path class="circus-arc-donations" d="M20 100 A80 80 0 0 1 180 100" />
        <g class="circus-arc-markers"></g>
      </svg>
      <div class="circus-arc-centre">
        <div class="circus-amount-main">${formatNZD(effectiveAmount)} total impact so far</div>
      </div>
    </div>

    <div class="circus-donation-pill">
      <span class="circus-donation-pill-tag">Support</span>
      <span>${formatNZD(rawAmount)} has been raised through donations and community fundraising so far.</span>
    </div>
    <div class="circus-match-pill">
      <span class="circus-match-pill-tag">Matched</span>
      <span>Every dollar of the first ${formatNZD(matchCap)} raised will be doubled by anonymous supporters, creating up to ${formatNZD(matchMaxImpact)} of impact.</span>
    </div>

    <ul class="circus-milestones">
      ${milestones.map(m => {
        const status = milestoneStatus(effectiveAmount, m);
        return `
          <li class="circus-milestone ${status}">
            <span class="circus-milestone-dot"></span>
            <div class="circus-milestone-main">${milestoneLabelAmount(m)}</div>
            <div class="circus-milestone-amount">
              ${status === 'reached' ? 'Reached' : status === 'active' ? 'In progress' : 'Upcoming'}
            </div>
            <div class="circus-milestone-text">${m.label}</div>
          </li>
        `;
      }).join('')}
    </ul>
  `;

  // ----- ARC ANIMATION + LABELLED MARKERS -----
  const impactPath = container.querySelector('.circus-arc-impact');
  const donationsPath = container.querySelector('.circus-arc-donations');
  const markersGroup = container.querySelector('.circus-arc-markers');

  const NS = 'http://www.w3.org/2000/svg';
  const centreX = 100;
  const centreY = 100;
  const radius = 80;

  function setArcProgress(path, percent) {
    const length = path.getTotalLength();
    const clamped = Math.min(Math.max(percent, 0), 1);
    path.style.strokeDasharray = String(length);
    path.style.strokeDashoffset = String(length * (1 - clamped));
  }

  // Position dots + labels along the arc for each milestone
  milestones.forEach(m => {
    const t = (m.start || 0) / topGoal; // 0–1
    const clamped = Math.min(Math.max(t, 0), 1);
    const theta = Math.PI * (1 - clamped); // 180° (left) to 0° (right)
    const x = centreX + radius * Math.cos(theta);
    const y = centreY - radius * Math.sin(theta); // subtract because SVG y-axis increases downward

    // Direction outward from centre for pointer + label
    const vx = x - centreX;
    const vy = y - centreY;
    const mag = Math.max(0.0001, Math.hypot(vx, vy));
    const nx = vx / mag;
    const ny = vy / mag;

    const lineEndX = x + nx * 12;
    const lineEndY = y + ny * 12;
    const labelX = lineEndX + nx * 4;
    const labelY = lineEndY + ny * 4;

    const status = milestoneStatus(effectiveAmount, m);
    const statusClass = 'circus-arc-marker-' + status;

    // text anchor so labels don’t collide too badly
    const anchor =
      x < 80 ? 'start' :
      x > 120 ? 'end' : 'middle';

    const group = document.createElementNS(NS, 'g');
    group.classList.add(statusClass);

    const line = document.createElementNS(NS, 'line');
    line.setAttribute('x1', x.toFixed(2));
    line.setAttribute('y1', y.toFixed(2));
    line.setAttribute('x2', lineEndX.toFixed(2));
    line.setAttribute('y2', lineEndY.toFixed(2));
    line.setAttribute('class', 'circus-arc-marker-line');

    const dot = document.createElementNS(NS, 'circle');
    dot.setAttribute('cx', x.toFixed(2));
    dot.setAttribute('cy', y.toFixed(2));
    dot.setAttribute('r', '3.2');
    dot.setAttribute('class', 'circus-arc-marker-dot');

    group.appendChild(line);
    group.appendChild(dot);
    markersGroup.appendChild(group);
  });

  // apply progress:
  // - impact arc = total impact (incl. match)
  // - donations arc = actual donations, overlaid on top
  const impactPercent = effectiveAmount / topGoal;
  const donationPercent = rawAmount / topGoal;

  setTimeout(() => {
    setArcProgress(impactPath, impactPercent);
    setArcProgress(donationsPath, donationPercent);
  }, 50);
})();
</script>
